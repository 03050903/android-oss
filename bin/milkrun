#!/usr/bin/env ruby

$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'milkrun'
require_relative '../config/initializer'
require 'commander'

class MilkrunApplication
  include Commander::Methods

  def run
    program :name, 'Milkrun'
    program :version, '0.0.1'
    program :description, 'Command-line tool for deploying the Kickstarter Android app'

    command :builds do |c|
      c.syntax = "milkrun builds"
      c.description = "Show list of published builds"
      c.action do |args, options|
        puts Milkrun::BuildList.new.fetch.to_yaml
      end
    end

    command :external do |c|
      c.syntax = 'milkrun external'
      c.description = 'TODO: Submit a new external build to the Play Store'
      c.action do |args, options|
      end
    end

    command :internal do |c|
      c.syntax = 'milkrun internal'
      c.description = "Submit a new internal build to S3"
      c.action do |args, options|
        audience = 'internal'
        build_type = 'release'
        Milkrun.prompt <<-CHECKLIST
Release checklist!

1) Make sure the build passes in CircleCI.
2) Run view tests: ./gradlew connectedInternalMin21DebugAndroidTest
3) Build and run locally in internalPre21Release mode, test core features on a real device.
CHECKLIST
        Milkrun::Git.new.check
        version_code = Milkrun::VersionCode.new.bump
        version_name = Milkrun::VersionName.new.prompt
        file_path = Milkrun::Build.new(audience: audience, build_type: build_type).compile
        Milkrun::HockeyApp.new(audience: audience, version_code: version_code, version_name: version_name).create_version
        Milkrun::S3Package.new(version_code: version_code, file_path: file_path).upload
        Milkrun::Changelog.new(audience: audience, build_type: build_type, version_code: version_code).publish
        Milkrun.say "All done, now commit your local version changes! ðŸ‘Œ"
      end
    end

    command :"update-strings" do |c|
      c.syntax = "milkrun update-strings"
      c.description = "refresh config and create string resources"
      c.option "--local", "Use local development server instead of production"
      c.action do |args, options|
        Milkrun::ServerConfigRefresher.new(local: (options.local || false)).refresh
        Milkrun::I18nStringResources.new.create
      end
    end

    run!
  end
end

MilkrunApplication.new.run if $0 == __FILE__
