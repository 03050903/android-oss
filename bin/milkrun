#!/usr/bin/env ruby

$:.unshift File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'milkrun'
require_relative '../config/initializer'
require 'commander'

class MilkrunApplication
  include Commander::Methods

  def run
    program :name, 'Milkrun'
    program :version, '0.0.1'
    program :description, 'Command-line tool for deploying the Kickstarter Android app'

    command :internal do |c|
      c.syntax = 'milkrun internal'
      c.description = "Submit a new internal build to S3"
      c.action do |args, options|
        variant = 'internal'
        version_code = Milkrun::VersionCode.new.bump
        version_name = Milkrun::VersionName.new.prompt
        file_path = Milkrun::Build.new(variant).compile
        Milkrun::S3Package.new(variant: variant, version_code: version_code, file_path: file_path).upload
        Milkrun::Changelog.new(variant: variant, version_code: version_code).publish
        Milkrun.say "All done! ðŸ‘Œ"
      end
    end

    command :external do |c|
      c.syntax = 'milkrun external'
      c.description = 'TODO: Submit a new external build to the Play Store'
      c.action do |args, options|
      end
    end

    command :builds do |c|
      c.syntax = "milkrun builds"
      c.description = "Show list of published builds"
      c.action do |args, options|
        puts Milkrun::BuildList.new.fetch.to_yaml
      end
    end

    run!
  end
end

MilkrunApplication.new.run if $0 == __FILE__
